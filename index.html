<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonar Book Alignment - Audiobooks Demo</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
    <!-- CocoSsd model for object detection -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
    <style>
        :root {
            --primary-color: #2d4057; /* Dark blue from Sonar logo */
            --secondary-color: #4d91b8; /* Medium blue from site */
            --accent-color: #e67e22; /* Orange from "LEARNING" text */
            --light-accent: #6bc7f1; /* Light blue from "BUILD OCRU" */
            --dark-color: #304a65; /* Darker blue for text */
            --light-color: #f8f9fa; /* Light background */
            --button-color: #70a7c4; /* Button blue */
            --success-color: #2ecc71; /* Green for success */
            --warning-color: #f1c40f; /* Yellow for warnings */
            --danger-color: #e74c3c; /* Red for errors */
            --perfect-color: rgba(46, 204, 113, 0.9); /* Semi-transparent green */
            --warning-color-bg: rgba(241, 196, 15, 0.9); /* Semi-transparent yellow */
            --danger-color-bg: rgba(231, 76, 60, 0.9); /* Semi-transparent red */
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--light-color);
            color: var(--dark-color);
            padding: 0;
            margin: 0;
            min-height: 100vh;
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        .header {
            background-color: white;
            color: var(--primary-color);
            padding: 1rem 0;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-bottom: 1px solid #eaeaea;
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .brand-logo {
            width: 50px;
            height: 50px;
        }
        
        .brand-name {
            font-weight: 700;
            font-size: 1.6rem;
            margin: 0;
            color: var(--primary-color);
        }
        
        .main-title {
            text-align: center;
            color: var(--primary-color);
            font-weight: 700;
            font-size: 2.5rem;
            margin: 2rem 0;
        }
        
        .sub-title {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 3rem;
        }
        
        .sub-title .blue-text {
            color: var(--light-accent);
        }
        
        .sub-title .orange-text {
            color: var(--accent-color);
        }
        
        .video-container {
            position: relative;
            max-width: 100%;
            margin: 0 auto;
            border: 3px solid var(--primary-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
        
        .video-container:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }
        
        #video {
            width: 100%;
            display: block;
            background-color: #000;
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .status-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 24px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(4px);
            z-index: 10;
        }
        
        .status-perfect {
            background-color: var(--perfect-color) !important;
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.5);
        }
        
        .status-warning {
            background-color: var(--warning-color-bg) !important;
        }
        
        .status-danger {
            background-color: var(--danger-color-bg) !important;
        }
        
        .movement-indicator {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 100px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            color: white;
            top: 50%;
            left: 50%;
            margin-top: -50px;
            margin-left: -50px;
            opacity: 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
            z-index: 5;
        }
        
        .indicator-visible {
            opacity: 1;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .card:hover {
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
        }
        
        .card-body {
            padding: 15px;
        }
        
        .controls {
            margin: 15px auto;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            max-width: 800px;
        }
        
        .controls .btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .controls .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--dark-color);
            border-color: var(--dark-color);
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-secondary:hover {
            background-color: #407ba0;
            border-color: #407ba0;
        }
        
        .btn-warning {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .btn-warning:hover {
            background-color: #d35400;
            border-color: #d35400;
        }
        
        .btn-demo {
            background-color: var(--button-color);
            border-color: var(--button-color);
            color: white;
            font-weight: 600;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-demo:hover {
            background-color: #5c93af;
            border-color: #5c93af;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .btn-ocr {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
            font-weight: 600;
            padding: 16px 30px;
            border-radius: 8px;
            font-size: 1.2rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            margin: 15px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            max-width: 250px;
        }
        
        .btn-ocr:hover {
            background-color: #d35400;
            border-color: #d35400;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .feature-item:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .feature-icon {
            font-size: 1.2rem;
            width: 30px;
            color: var(--secondary-color);
            text-align: center;
        }
        
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat-item {
            flex: 1;
            min-width: 120px;
            background-color: rgba(44, 62, 80, 0.05);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            transition: transform 0.2s ease;
        }
        
        .stat-item:hover {
            transform: translateY(-2px);
            background-color: rgba(44, 62, 80, 0.08);
        }
        
        .stat-value {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--secondary-color);
        }
        
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .setting-item {
            margin-bottom: 15px;
        }
        
        .setting-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .setting-value {
            font-weight: bold;
            color: var(--secondary-color);
            min-width: 40px;
            text-align: right;
        }
        
        .form-range {
            height: 8px;
        }
        
        .form-range::-webkit-slider-thumb {
            background: var(--secondary-color);
        }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--primary-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .footer {
            background-color: var(--primary-color);
            color: var(--light-color);
            padding: 1.5rem 0;
            margin-top: 2rem;
            text-align: center;
        }
        
        .footer a {
            color: var(--light-accent);
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: row;
                gap: 5px;
            }
            
            .controls .btn {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            .stats-container {
                flex-direction: row;
            }
            
            .status-overlay {
                font-size: 18px;
                padding: 8px 12px;
            }
            
            .main-title {
                font-size: 1.8rem;
            }
            
            .sub-title {
                font-size: 1.2rem;
            }
        }
        
        /* Animations */
        .flash {
            animation: flash 0.5s;
        }
        
        @keyframes flash {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Pulse animation for perfect alignment */
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(46, 204, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }
        
        /* Fullscreen styling */
        .fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            max-width: none !important;
            border: none !important;
            border-radius: 0 !important;
        }
        
        /* Toggle switches */
        .form-switch .form-check-input {
            width: 3em;
            height: 1.5em;
            margin-left: -3.5em;
        }
        
        /* Guide overlay */
        .guide-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 6;
            opacity: 0.7;
            display: none;
        }
        
        .guide-rect {
            position: absolute;
            border: 3px dashed var(--accent-color);
            box-sizing: border-box;
        }
        
        .guide-text {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            font-size: 16px;
            border-radius: 5px;
            pointer-events: none;
        }
        
        /* Direction arrows */
        .direction-arrow {
            position: absolute;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            color: white;
            background-color: rgba(241, 196, 15, 0.8);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 5;
        }
        
        .arrow-up {
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .arrow-down {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .arrow-left {
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
        }
        
        .arrow-right {
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
        }
        
        .arrow-visible {
            opacity: 1;
        }
        
        /* Alert feedback */
        .alert-feedback {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 250px;
            max-width: 350px;
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .alert-feedback.show {
            transform: translateX(0);
        }
        
        /* Thai language specific styles */
        .thai-text {
            font-family: 'Prompt', sans-serif;
        }
        
        /* Camera UI Controls */
        .camera-ui-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            padding: 12px;
            border-radius: 12px;
            z-index: 15;
            width: 90%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .camera-ui-controls .control-group {
            width: 100%;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
        }
        
        .camera-ui-controls .control-label {
            color: white;
            font-weight: 600;
            min-width: 120px;
        }
        
        .camera-ui-controls .form-range {
            flex-grow: 1;
        }
        
        .camera-ui-controls .setting-value {
            color: white;
            min-width: 60px;
            text-align: center;
        }
        
        .camera-ui-toggle {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 15;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .camera-ui-toggle:hover {
            background-color: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }
        
        .hide-ui {
            display: none !important;
        }
        
        /* OCR Styles */
        .ocr-highlighted-text {
            background-color: rgba(46, 204, 113, 0.2);
            border-radius: 3px;
            padding: 2px 4px;
            margin: 2px 0;
            display: inline-block;
        }
        
        .ocr-word {
            position: relative;
            display: inline-block;
            border-radius: 2px;
            margin: 0 2px;
            transition: all 0.2s ease;
        }
        
        .ocr-word:hover {
            background-color: rgba(52, 152, 219, 0.2);
        }
        
        .ocr-capture-area {
            position: absolute;
            border: 2px dashed var(--accent-color);
            pointer-events: none;
            z-index: 7;
            display: none;
        }
        
        .ocr-capture-flash {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.6);
            z-index: 8;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .ocr-flash-active {
            opacity: 1;
            animation: ocr-flash 0.5s ease-out;
        }
        
        @keyframes ocr-flash {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        #ocr-preview {
            background-color: #f8f9fa;
            border-color: #dee2e6 !important;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .ocr-text-thai {
            font-family: 'Prompt', sans-serif;
            line-height: 1.6;
        }
        
        /* Panel buttons */
        .panel-button {
            position: fixed;
            bottom: 20px;
            background-color: var(--primary-color);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .panel-button:hover {
            transform: scale(1.1);
        }
        
        .settings-toggle {
            right: 20px;
        }
        
        .accessibility-toggle {
            left: 20px;
            background-color: var(--secondary-color);
        }
        
        /* Panels */
        .side-panel {
            position: fixed;
            top: 0;
            width: 300px;
            height: 100vh;
            background-color: white;
            z-index: 999;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .panel-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 20px;
            cursor: pointer;
            color: var(--primary-color);
        }
        
        .settings-panel {
            right: -320px;
        }
        
        .settings-panel.active {
            right: 0;
        }
        
        .accessibility-panel {
            left: -320px;
        }
        
        .accessibility-panel.active {
            left: 0;
        }
        
        /* Section headings */
        .settings-heading {
            position: relative;
            padding-bottom: 5px;
            margin-bottom: 15px;
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
            font-size: 1rem;
        }
        
        /* Navbar menu */
        .navbar-menu {
            display: flex;
            gap: 20px;
        }
        
        .navbar-menu a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.2s ease;
        }
        
        .navbar-menu a:hover {
            background-color: rgba(45, 64, 87, 0.05);
        }
        
        /* Demo box styling */
        .demo-box {
            background-color: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        /* OCR Result area styling */
        .ocr-result-card {
            border-radius: 10px;
            overflow: hidden;
            margin-top: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .ocr-result-header {
            background-color: var(--accent-color);
            color: white;
            padding: 15px;
            font-weight: 600;
        }
        
        .ocr-result-body {
            padding: 20px;
            background-color: white;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <h3>Loading Sonar Book Alignment</h3>
        <p id="loading-progress">Preparing camera and AI models...</p>
    </div>

    <!-- Alert Feedback -->
    <div id="alert-feedback" class="alert alert-success alert-feedback">
        <div class="d-flex align-items-center">
            <i class="fas fa-check-circle me-2"></i>
            <div id="alert-message">Settings updated successfully!</div>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="app-container">
            <div class="d-flex justify-content-between align-items-center">
                <div class="brand">
                    <img src="https://i.imgur.com/gNqAhxP.png" alt="Sonar Audiobooks" class="brand-logo">
                    <h1 class="brand-name">SONAR AUDIOBOOKS</h1>
                </div>
                <div class="navbar-menu">
                    <a href="#">Home</a>
                    <a href="#">About Us</a>
                    <a href="#">Contact us</a>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Title Section -->
        <h1 class="main-title">SONAR-AUDIOBOOKS</h1>
        <h2 class="sub-title">
            <span class="blue-text">BUILD OCRU</span> 
            <span class="orange-text">LEARNING</span>
            <span class="blue-text">THROUGH AUDIO BOOKS</span>
        </h2>
        
        <div class="row">
            <!-- Main Camera View -->
            <div class="col-lg-8 mb-4">
                <div class="video-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                    <div id="status-overlay" class="status-overlay">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Initializing camera...</span>
                    </div>
                    
                    <!-- Direction arrows -->
                    <div id="arrow-up" class="direction-arrow arrow-up"><i class="fas fa-arrow-up"></i></div>
                    <div id="arrow-down" class="direction-arrow arrow-down"><i class="fas fa-arrow-down"></i></div>
                    <div id="arrow-left" class="direction-arrow arrow-left"><i class="fas fa-arrow-left"></i></div>
                    <div id="arrow-right" class="direction-arrow arrow-right"><i class="fas fa-arrow-right"></i></div>
                    
                    <!-- Movement indicator -->
                    <div id="movement-indicator" class="movement-indicator">
                        <i id="movement-icon" class="fas"></i>
                    </div>
                    
                    <!-- Guide overlay -->
                    <div id="guide-overlay" class="guide-overlay"></div>
                    
                    <!-- OCR capture area and flash -->
                    <div id="ocr-capture-area" class="ocr-capture-area"></div>
                    <div id="ocr-capture-flash" class="ocr-capture-flash"></div>
                    
                    <!-- Camera UI Controls -->
                    <div id="camera-ui-controls" class="camera-ui-controls">
                        <div class="control-group">
                            <div class="control-label">Rectangle Width</div>
                            <input type="range" class="form-range" min="30" max="90" step="5" value="70" id="ui-rect-width">
                            <div class="setting-value" id="ui-rect-width-value">70%</div>
                        </div>
                        <div class="control-group">
                            <div class="control-label">Rectangle Height</div>
                            <input type="range" class="form-range" min="30" max="90" step="5" value="80" id="ui-rect-height">
                            <div class="setting-value" id="ui-rect-height-value">80%</div>
                        </div>
                    </div>
                    
                    <!-- Camera UI Toggle -->
                    <div id="camera-ui-toggle" class="camera-ui-toggle">
                        <i class="fas fa-sliders-h"></i>
                    </div>
                </div>
                
                <!-- Camera Controls -->
                <div class="controls mb-4">
                    <button id="camera-toggle" class="btn btn-primary">
                        <i class="fas fa-camera-rotate"></i> Switch Camera
                    </button>
                    <button id="audio-toggle" class="btn btn-secondary">
                        <i class="fas fa-volume-high"></i> Audio
                    </button>
                    <button id="snapshot-btn" class="btn btn-warning">
                        <i class="fas fa-camera"></i> Snapshot
                    </button>
                    <button id="fullscreen-btn" class="btn btn-info">
                        <i class="fas fa-expand"></i> Fullscreen
                    </button>
                    <button id="guide-toggle" class="btn btn-secondary">
                        <i class="fas fa-ruler-combined"></i> Guide
                    </button>
                </div>
                
                <!-- OCR Button - Prominent and Easy to Click -->
                <button id="ocr-capture-btn" class="btn btn-ocr">
                    <i class="fas fa-camera me-2"></i> Capture Text
                </button>
                
                <!-- OCR Area -->
                <div class="ocr-result-card">
                    <div class="ocr-result-header">
                        <i class="fas fa-file-alt me-2"></i> OCR Results
                    </div>
                    <div class="ocr-result-body">
                        <div id="ocr-status" class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> 
                            Loading OCR functionality...
                        </div>
                        
                        <div class="d-flex align-items-center mb-3">
                            <div class="form-check form-switch ms-2">
                                <input class="form-check-input" type="checkbox" id="ocr-auto-capture" checked>
                                <label class="form-check-label" for="ocr-auto-capture">Auto-capture when aligned</label>
                            </div>
                        </div>
                        
                        <div class="d-flex mb-3">
                            <div class="form-check me-3">
                                <input class="form-check-input" type="radio" name="ocr-lang" id="ocr-lang-tha" value="tha" checked>
                                <label class="form-check-label" for="ocr-lang-tha">
                                    <span class="thai-text">ไทย</span> (Thai)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="ocr-lang" id="ocr-lang-eng" value="eng">
                                <label class="form-check-label" for="ocr-lang-eng">
                                    English
                                </label>
                            </div>
                        </div>
                        
                        <div id="ocr-progress" class="progress mb-3" style="display: none;">
                            <div id="ocr-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                role="progressbar" style="width: 0%" 
                                aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        
                        <div id="ocr-preview" class="border rounded mb-3 p-3" style="min-height: 150px; max-height: 300px; overflow-y: auto; display: none;">
                            <div id="ocr-text" class="thai-text"></div>
                        </div>
                        
                        <div class="d-flex justify-content-end">
                            <button id="ocr-copy-btn" class="btn btn-sm btn-outline-secondary me-2" disabled>
                                <i class="fas fa-copy me-1"></i> Copy
                            </button>
                            <button id="ocr-speak-btn" class="btn btn-sm btn-outline-secondary" disabled>
                                <i class="fas fa-volume-up me-1"></i> Speak
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- About Section -->
                <div class="accordion mt-4" id="aboutAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="aboutHeading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#aboutCollapse" aria-expanded="false" aria-controls="aboutCollapse">
                                <i class="fas fa-info-circle me-2"></i> About Sonar Book Alignment
                            </button>
                        </h2>
                        <div id="aboutCollapse" class="accordion-collapse collapse" aria-labelledby="aboutHeading" data-bs-parent="#aboutAccordion">
                            <div class="accordion-body">
                                <p>Sonar Book Alignment is a cutting-edge technology designed to help visually impaired individuals properly position books for scanning and conversion to audiobooks. This web demo showcases the core functionality of the system.</p>
                                
                                <h5>Features:</h5>
                                <div class="feature-item">
                                    <div class="feature-icon"><i class="fas fa-camera"></i></div>
                                    <div>Real-time book detection and tracking using AI</div>
                                </div>
                                <div class="feature-item">
                                    <div class="feature-icon"><i class="fas fa-volume-up"></i></div>
                                    <div>Audio guidance in Thai and English for proper positioning</div>
                                </div>
                                <div class="feature-item">
                                    <div class="feature-icon"><i class="fas fa-mobile-alt"></i></div>
                                    <div>Works on any device with a camera and modern browser</div>
                                </div>
                                <div class="feature-item">
                                    <div class="feature-icon"><i class="fas fa-universal-access"></i></div>
                                    <div>Designed for accessibility with clear visual and audio cues</div>
                                </div>
                                <div class="feature-item">
                                    <div class="feature-icon"><i class="fas fa-cogs"></i></div>
                                    <div>Adjustable settings to suit different books and environments</div>
                                </div>
                                
                                <p class="mt-3">This demo is part of the Sonar Audiobooks project, which aims to improve access to books for visually impaired individuals in Thailand through AI-powered audiobook conversion.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Status Panel -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-tachometer-alt"></i> Detection Status
                    </div>
                    <div class="card-body">
                        <div id="status-details">
                            <div class="text-center py-3">
                                <i class="fas fa-book fa-3x mb-3 text-secondary"></i>
                                <p><strong>No book detected yet.</strong></p>
                                <p class="text-muted">Hold a book in front of the camera</p>
                            </div>
                        </div>
                        
                        <!-- Statistics -->
                        <h6 class="mt-4 mb-2">Detection Statistics</h6>
                        <div class="stats-container">
                            <div class="stat-item">
                                <div class="stat-value" id="stat-detections">0</div>
                                <div class="stat-label">Detections</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-confidence">0%</div>
                                <div class="stat-label">Confidence</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Instructions Panel -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-info-circle"></i> Instructions
                    </div>
                    <div class="card-body">
                        <ol>
                            <li>Hold a book in front of the camera</li>
                            <li>Align it with the yellow rectangle</li>
                            <li>Follow the audio and visual guidance</li>
                            <li>Green status means perfect alignment</li>
                            <li>Press the "Capture Text" button or wait for auto-capture</li>
                            <li>OCR will extract text from the aligned book</li>
                        </ol>
                        
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-lightbulb me-2"></i> 
                            <strong>Tip:</strong> Try to keep the book parallel to the camera for best results.
                        </div>
                    </div>
                </div>
                
                <!-- Demo Trial Button -->
                <div class="demo-box">
                    <h4 class="mb-3">Want to try more features?</h4>
                    <button class="btn btn-demo">DEMO TRIAL</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Toggle -->
    <div id="settings-toggle" class="panel-button settings-toggle">
        <i class="fas fa-cog"></i>
    </div>
    
    <!-- Settings Panel -->
    <div id="settings-panel" class="side-panel settings-panel">
        <div id="settings-close" class="panel-close">
            <i class="fas fa-times"></i>
        </div>
        <h4 class="mb-4">Settings</h4>
        
        <div class="settings-heading">Detection Settings</div>
            
        <div class="setting-item">
            <div class="setting-label">
                <span>Detection Confidence</span>
                <span class="setting-value" id="confidence-value">0.5</span>
            </div>
            <input type="range" class="form-range" min="0.1" max="0.9" step="0.05" value="0.5" id="confidence-threshold">
        </div>
        
        <div class="settings-heading">Alignment Settings</div>
        
        <div class="setting-item">
            <div class="setting-label">
                <span>Horizontal Tolerance</span>
                <span class="setting-value" id="tolerance-x-value">0.05</span>
            </div>
            <input type="range" class="form-range" min="0.01" max="0.15" step="0.01" value="0.05" id="position-tolerance-x">
        </div>
        
        <div class="setting-item">
            <div class="setting-label">
                <span>Vertical Tolerance</span>
                <span class="setting-value" id="tolerance-y-value">0.07</span>
            </div>
            <input type="range" class="form-range" min="0.01" max="0.15" step="0.01" value="0.07" id="position-tolerance-y">
        </div>
        
        <div class="setting-item">
            <div class="setting-label">
                <span>Minimum Size Ratio</span>
                <span class="setting-value" id="min-size-value">0.5</span>
            </div>
            <input type="range" class="form-range" min="0.2" max="0.9" step="0.05" value="0.5" id="min-size-ratio">
        </div>
        
        <div class="setting-item">
            <div class="setting-label">
                <span>Maximum Size Ratio</span>
                <span class="setting-value" id="max-size-value">1.2</span>
            </div>
            <input type="range" class="form-range" min="1.0" max="2.0" step="0.1" value="1.2" id="max-size-ratio">
        </div>
        
        <div class="settings-heading">Direction Settings</div>
        
        <div class="setting-item">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="reverse-directions">
                <label class="form-check-label" for="reverse-directions">Reverse Directions</label>
            </div>
            <small class="text-muted d-block mt-1">
                Auto-enabled for computer setup
            </small>
        </div>
        
        <div class="settings-heading">Display Options</div>
        
        <div class="setting-item">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="detection-highlight" checked>
                <label class="form-check-label" for="detection-highlight">Highlight Books</label>
            </div>
        </div>
        
        <div class="setting-item">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="show-center-marker" checked>
                <label class="form-check-label" for="show-center-marker">Show Center Marker</label>
            </div>
        </div>
        
        <div class="setting-item">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="show-direction-arrows" checked>
                <label class="form-check-label" for="show-direction-arrows">Show Direction Arrows</label>
            </div>
        </div>
        
        <div class="mt-3 d-grid gap-2">
            <button class="btn btn-outline-secondary btn-sm" id="reset-settings">
                <i class="fas fa-undo me-2"></i>Reset to Defaults
            </button>
        </div>
    </div>
    
    <!-- Accessibility Toggle -->
    <div id="accessibility-toggle" class="panel-button accessibility-toggle">
        <i class="fas fa-universal-access"></i>
    </div>
    
    <!-- Accessibility Panel -->
    <div id="accessibility-panel" class="side-panel accessibility-panel">
        <div id="accessibility-close" class="panel-close">
            <i class="fas fa-times"></i>
        </div>
        <h4 class="mb-4">Accessibility Options</h4>
        
        <div class="setting-item">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="high-contrast-mode">
                <label class="form-check-label" for="high-contrast-mode">High Contrast Mode</label>
            </div>
            <small class="text-muted d-block mt-1">
                Increases contrast for better visibility
            </small>
        </div>
        
        <div class="setting-item">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="larger-elements">
                <label class="form-check-label" for="larger-elements">Larger Elements</label>
            </div>
            <small class="text-muted d-block mt-1">
                Increases size of text and controls
            </small>
        </div>
        
        <div class="setting-item">
            <div class="setting-label">
                <span>Speaking Rate</span>
                <span class="setting-value" id="speech-rate-value">1.0</span>
            </div>
            <input type="range" class="form-range" min="0.5" max="2" step="0.1" value="1.0" id="speech-rate">
        </div>
        
        <div class="setting-item">
            <div class="setting-label">
                <span>Speaking Volume</span>
                <span class="setting-value" id="speech-volume-value">1.0</span>
            </div>
            <input type="range" class="form-range" min="0.1" max="1" step="0.1" value="1.0" id="speech-volume">
        </div>
        
        <div class="setting-item">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="repeat-instructions">
                <label class="form-check-label" for="repeat-instructions">Repeat Instructions</label>
            </div>
            <small class="text-muted d-block mt-1">
                Repeat voice guidance more frequently
            </small>
        </div>
        
        <div class="setting-item">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="extra-audio-cues">
                <label class="form-check-label" for="extra-audio-cues">Extra Audio Cues</label>
            </div>
            <small class="text-muted d-block mt-1">
                Add more detailed audio guidance
            </small>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="app-container">
            <p>Sonar Book Alignment Demo - A project for accessibility</p>
            <p>© 2025 Sonar Audiobooks - Helping visually impaired individuals access books in Thailand</p>
        </div>
    </div>

    <!-- Bootstrap & Popper JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Configuration
        let config = {
            // Target rectangle dimensions (percentage of screen)
            targetWidthRatio: 0.7,
            targetHeightRatio: 0.8,
            
            // Alignment thresholds
            positionThresholdXRatio: 0.05,
            positionThresholdYRatio: 0.07, // Slightly larger for vertical tolerance
            
            // Size thresholds
            minSizeRatio: 0.5,
            maxSizeRatio: 1.2,
            
            // Other settings
            instructionCooldown: 3000, // ms
            detectionConfidence: 0.5,
            highlightDetections: true,
            showCenterMarker: true,
            showDirectionArrows: true,
            reverseDirections: false,
            directionArrowDuration: 2000, // ms
            
            // Accessibility settings
            highContrastMode: false,
            largerElements: false,
            speechRate: 1.0,
            speechVolume: 1.0,
            repeatInstructions: false,
            extraAudioCues: false
        };
        
        // Speech messages
        const messages = {
            'perfect': {
                'th': 'สมบูรณ์แบบ',
                'en': 'perfect'
            },
            'left': {
                'th': 'เลื่อนซ้าย',
                'en': 'left'
            },
            'right': {
                'th': 'เลื่อนขวา',
                'en': 'right'
            },
            'up': {
                'th': 'เลื่อนขึ้น',
                'en': 'up'
            },
            'down': {
                'th': 'เลื่อนลง',
                'en': 'down'
            },
            'closer': {
                'th': 'เข้าใกล้มากขึ้น',
                'en': 'closer'
            },
            'further': {
                'th': 'ถอยออกไป',
                'en': 'further'
            },
            'no_book': {
                'th': 'ไม่เห็นหนังสือ',
                'en': 'no book'
            }
        };
        
        // Elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusOverlay = document.getElementById('status-overlay');
        const statusDetails = document.getElementById('status-details');
        const cameraToggle = document.getElementById('camera-toggle');
        const audioToggle = document.getElementById('audio-toggle');
        const snapshotBtn = document.getElementById('snapshot-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const guideToggle = document.getElementById('guide-toggle');
        const guideOverlay = document.getElementById('guide-overlay');
        const loadingScreen = document.getElementById('loading-screen');
        const loadingProgress = document.getElementById('loading-progress');
        const movementIndicator = document.getElementById('movement-indicator');
        const movementIcon = document.getElementById('movement-icon');
        const alertFeedback = document.getElementById('alert-feedback');
        const alertMessage = document.getElementById('alert-message');
        
        // Camera UI Controls
        const cameraUiControls = document.getElementById('camera-ui-controls');
        const cameraUiToggle = document.getElementById('camera-ui-toggle');
        const uiRectWidth = document.getElementById('ui-rect-width');
        const uiRectWidthValue = document.getElementById('ui-rect-width-value');
        const uiRectHeight = document.getElementById('ui-rect-height');
        const uiRectHeightValue = document.getElementById('ui-rect-height-value');
        
        // Settings panel
        const settingsPanel = document.getElementById('settings-panel');
        const settingsToggle = document.getElementById('settings-toggle');
        const settingsClose = document.getElementById('settings-close');
        
        // Accessibility panel
        const accessibilityPanel = document.getElementById('accessibility-panel');
        const accessibilityToggle = document.getElementById('accessibility-toggle');
        const accessibilityClose = document.getElementById('accessibility-close');
        
        // Direction arrows
        const arrowUp = document.getElementById('arrow-up');
        const arrowDown = document.getElementById('arrow-down');
        const arrowLeft = document.getElementById('arrow-left');
        const arrowRight = document.getElementById('arrow-right');
        
        // Settings elements
        const confidenceThreshold = document.getElementById('confidence-threshold');
        const confidenceValue = document.getElementById('confidence-value');
        const positionToleranceX = document.getElementById('position-tolerance-x');
        const toleranceXValue = document.getElementById('tolerance-x-value');
        const positionToleranceY = document.getElementById('position-tolerance-y');
        const toleranceYValue = document.getElementById('tolerance-y-value');
        const minSizeRatio = document.getElementById('min-size-ratio');
        const minSizeValue = document.getElementById('min-size-value');
        const maxSizeRatio = document.getElementById('max-size-ratio');
        const maxSizeValue = document.getElementById('max-size-value');
        const reverseDirections = document.getElementById('reverse-directions');
        const detectionHighlight = document.getElementById('detection-highlight');
        const showCenterMarker = document.getElementById('show-center-marker');
        const showDirectionArrows = document.getElementById('show-direction-arrows');
        const resetSettings = document.getElementById('reset-settings');
        
        // Accessibility elements
        const highContrastMode = document.getElementById('high-contrast-mode');
        const largerElements = document.getElementById('larger-elements');
        const speechRate = document.getElementById('speech-rate');
        const speechRateValue = document.getElementById('speech-rate-value');
        const speechVolume = document.getElementById('speech-volume');
        const speechVolumeValue = document.getElementById('speech-volume-value');
        const repeatInstructions = document.getElementById('repeat-instructions');
        const extraAudioCues = document.getElementById('extra-audio-cues');
        
        // Statistics elements
        const statDetections = document.getElementById('stat-detections');
        const statConfidence = document.getElementById('stat-confidence');
        
        // OCR elements
        const ocrCaptureBtn = document.getElementById('ocr-capture-btn');
        const ocrAutoCapture = document.getElementById('ocr-auto-capture');
        const ocrLangTha = document.getElementById('ocr-lang-tha');
        const ocrLangEng = document.getElementById('ocr-lang-eng');
        const ocrStatus = document.getElementById('ocr-status');
        const ocrPreview = document.getElementById('ocr-preview');
        const ocrText = document.getElementById('ocr-text');
        const ocrProgress = document.getElementById('ocr-progress');
        const ocrProgressBar = document.getElementById('ocr-progress-bar');
        const ocrCopyBtn = document.getElementById('ocr-copy-btn');
        const ocrSpeakBtn = document.getElementById('ocr-speak-btn');
        const ocrCaptureArea = document.getElementById('ocr-capture-area');
        const ocrCaptureFlash = document.getElementById('ocr-capture-flash');
        
        // State
        let model;
        let facingMode = 'user'; // or 'environment'
        let audioEnabled = true;
        let guideVisible = false;
        let cameraUiVisible = true;
        let lastInstructionTime = 0;
        let currentState = null;
        let lastBookDetectionTime = 0;
        let targetArea = {
            x: 0,
            y: 0,
            width: 0,
            height: 0
        };
        let detectionCount = 0;
        let lastConfidence = 0;
        let arrowTimeout;
        let alertTimeout;
        let repeatTimeout;
        let isComputer = false;
        
        // OCR variables
        let ocrInitialized = false;
        let ocrProcessing = false;
        let ocrLastResult = '';
        let ocrAutoCaptureEnabled = true;
        let ocrLanguage = 'tha';
        let ocrWorker = null;
        let lastOCRCaptureTime = 0;
        let tesseractLoaded = false;
        
        // Status colors
        const statusColors = {
            'perfect': 'status-perfect',
            'left': 'status-warning',
            'right': 'status-warning',
            'up': 'status-warning',
            'down': 'status-warning',
            'closer': 'status-warning',
            'further': 'status-warning',
            'no_book': 'status-danger'
        };
        
        // Direction icons
        const directionIcons = {
            'up': 'fa-arrow-up',
            'down': 'fa-arrow-down',
            'left': 'fa-arrow-left',
            'right': 'fa-arrow-right',
            'closer': 'fa-search-plus',
            'further': 'fa-search-minus',
            'perfect': 'fa-check',
            'no_book': 'fa-book-slash'
        };
        
        // Initialize
        async function init() {
            try {
                // Detect device type
                detectDeviceType();
                
                // Apply device-specific settings
                if (isComputer) {
                    config.reverseDirections = true;
                    reverseDirections.checked = true;
                    showAlert('Computer detected - direction commands reversed', 'info');
                }
                
                loadingProgress.textContent = "Loading AI models...";
                
                // Load COCO-SSD model with simple configuration
                console.log('Loading object detection model...');
                model = await cocoSsd.load();
                console.log('Model loaded.');
                
                loadingProgress.textContent = "Starting camera...";
                
                // Start video
                await setupCamera();
                
                loadingProgress.textContent = "Initializing detection...";
                
                // Initialize settings
                initializeSettings();
                
                // Set up guide overlay
                updateGuideOverlay();
                
                // Add camera UI controls listeners
                setupCameraUiControls();
                
                // Start detection loop
                detectObjects();
                
                // Initialize OCR (load dynamically to avoid blocking)
                loadTesseract();
                
                // Hide loading screen
                loadingScreen.style.display = 'none';
                
                // Start with a welcome message
                if (audioEnabled) {
                    setTimeout(() => {
                        speak('ยินดีต้อนรับสู่ Sonar Book Alignment', 'th');
                    }, 1000);
                }
            } catch (error) {
                console.error('Initialization error:', error);
                loadingScreen.innerHTML = `
                    <div class="text-center p-4">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3 text-danger"></i>
                        <h4>Error Initializing</h4>
                        <p>${error.message || 'Could not initialize the application'}</p>
                        <button class="btn btn-primary mt-3" onclick="location.reload()">Try Again</button>
                    </div>
                `;
            }
        }
        
        // Dynamic loading of Tesseract.js
        function loadTesseract() {
            updateOCRStatus('loading', 'Loading OCR library...');
            
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js';
            script.async = true;
            
            script.onload = function() {
                console.log('Tesseract.js loaded successfully');
                tesseractLoaded = true;
                setTimeout(() => {
                    initializeOCR();
                }, 1000);
            };
            
            script.onerror = function() {
                console.error('Failed to load Tesseract.js');
                updateOCRStatus('error', 'Failed to load OCR library. Please try again later.');
            };
            
            document.body.appendChild(script);
        }
        
        // Initialize OCR
        async function initializeOCR() {
            if (!tesseractLoaded || typeof Tesseract === 'undefined') {
                updateOCRStatus('error', 'OCR library not available. Try refreshing the page.');
                return;
            }
            
            try {
                updateOCRStatus('initializing', 'Initializing OCR engine...');
                
                ocrWorker = Tesseract.createWorker();
                await ocrWorker.load();
                await ocrWorker.loadLanguage('tha');
                await ocrWorker.initialize('tha');
                
                ocrInitialized = true;
                updateOCRStatus('ready', 'OCR ready. Align a book and press "Capture Text".');
                
            } catch (error) {
                console.error('Error initializing OCR:', error);
                updateOCRStatus('error', 'OCR initialization failed. Please try again later.');
            }
        }
        
        // Detect device type
        function detectDeviceType() {
            // Check if using mobile device
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // Check if likely using computer (non-touch device with large screen)
            isComputer = window.innerWidth > 1024 && !isMobile && !('ontouchstart' in window);
            
            console.log(`Device detected: ${isComputer ? 'Computer' : 'Mobile/Tablet'}`);
        }
        
        // Set up camera UI controls listeners
        function setupCameraUiControls() {
            // Toggle camera UI controls
            cameraUiToggle.addEventListener('click', () => {
                cameraUiVisible = !cameraUiVisible;
                cameraUiControls.classList.toggle('hide-ui', !cameraUiVisible);
                cameraUiToggle.innerHTML = cameraUiVisible ? 
                    '<i class="fas fa-times"></i>' : 
                    '<i class="fas fa-sliders-h"></i>';
            });
            
            // Camera UI rectangle width control
            uiRectWidth.addEventListener('input', () => {
                const value = parseInt(uiRectWidth.value);
                uiRectWidthValue.textContent = `${value}%`;
                config.targetWidthRatio = value / 100;
                updateTargetArea();
                updateGuideOverlay();
            });
            
            // Camera UI rectangle height control
            uiRectHeight.addEventListener('input', () => {
                const value = parseInt(uiRectHeight.value);
                uiRectHeightValue.textContent = `${value}%`;
                config.targetHeightRatio = value / 100;
                updateTargetArea();
                updateGuideOverlay();
            });
        }
        
        // Initialize settings from UI
        function initializeSettings() {
            uiRectWidth.value = config.targetWidthRatio * 100;
            uiRectWidthValue.textContent = `${Math.round(config.targetWidthRatio * 100)}%`;
            
            uiRectHeight.value = config.targetHeightRatio * 100;
            uiRectHeightValue.textContent = `${Math.round(config.targetHeightRatio * 100)}%`;
            
            confidenceThreshold.value = config.detectionConfidence;
            confidenceValue.textContent = config.detectionConfidence;
            
            positionToleranceX.value = config.positionThresholdXRatio;
            toleranceXValue.textContent = config.positionThresholdXRatio;
            
            positionToleranceY.value = config.positionThresholdYRatio;
            toleranceYValue.textContent = config.positionThresholdYRatio;
            
            minSizeRatio.value = config.minSizeRatio;
            minSizeValue.textContent = config.minSizeRatio;
            
            maxSizeRatio.value = config.maxSizeRatio;
            maxSizeValue.textContent = config.maxSizeRatio;
            
            reverseDirections.checked = config.reverseDirections;
            detectionHighlight.checked = config.highlightDetections;
            showCenterMarker.checked = config.showCenterMarker;
            showDirectionArrows.checked = config.showDirectionArrows;
            
            // Accessibility settings
            highContrastMode.checked = config.highContrastMode;
            largerElements.checked = config.largerElements;
            speechRate.value = config.speechRate;
            speechRateValue.textContent = config.speechRate;
            speechVolume.value = config.speechVolume;
            speechVolumeValue.textContent = config.speechVolume;
            repeatInstructions.checked = config.repeatInstructions;
            extraAudioCues.checked = config.extraAudioCues;
            
            // Apply accessibility settings
            applyAccessibilitySettings();
        }
        
        // Apply accessibility settings
        function applyAccessibilitySettings() {
            // Apply high contrast mode
            document.body.classList.toggle('high-contrast', config.highContrastMode);
            
            // Apply larger elements mode
            document.body.classList.toggle('accessibility-mode', config.largerElements);
            
            // Update cooldown for instructions repeating
            config.instructionCooldown = config.repeatInstructions ? 2000 : 3000;
        }
        
        // Setup camera
        async function setupCamera() {
            const constraints = {
                video: {
                    facingMode: facingMode,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            try {
                // Stop any existing streams
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
                
                // Get new stream
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        // Update canvas dimensions
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        
                        // Calculate target area
                        updateTargetArea();
                        
                        // Update guide overlay
                        updateGuideOverlay();
                        
                        // Update status
                        statusOverlay.innerHTML = '<i class="fas fa-check-circle me-2"></i>Camera ready';
                        
                        resolve(video);
                    };
                });
            } catch (error) {
                console.error('Error accessing camera:', error);
                statusOverlay.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Camera access error';
                statusOverlay.classList.add('status-danger');
                throw error;
            }
        }
        
        // Update target area based on video dimensions and settings
        function updateTargetArea() {
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;
            
            targetArea = {
                width: Math.round(videoWidth * config.targetWidthRatio),
                height: Math.round(videoHeight * config.targetHeightRatio),
                x: 0,
                y: 0
            };
            
            targetArea.x = Math.round((videoWidth - targetArea.width) / 2);
            targetArea.y = Math.round((videoHeight - targetArea.height) / 2);
        }
        
        // Update guide overlay
        function updateGuideOverlay() {
            // Clear previous guide
            guideOverlay.innerHTML = '';
            
            // Create guide rectangle
            const guideRect = document.createElement('div');
            guideRect.className = 'guide-rect';
            guideRect.style.left = targetArea.x + 'px';
            guideRect.style.top = targetArea.y + 'px';
            guideRect.style.width = targetArea.width + 'px';
            guideRect.style.height = targetArea.height + 'px';
            
            // Add text labels
            const topLabel = document.createElement('div');
            topLabel.className = 'guide-text';
            topLabel.textContent = 'Place book within outline';
            topLabel.style.top = (targetArea.y - 30) + 'px';
            topLabel.style.left = (targetArea.x + targetArea.width / 2 - 100) + 'px';
            
            guideOverlay.appendChild(guideRect);
            guideOverlay.appendChild(topLabel);
        }
        
        // Show feedback alert
        function showAlert(message, type = 'success') {
            alertMessage.textContent = message;
            alertFeedback.className = `alert alert-${type} alert-feedback`;
            alertFeedback.classList.add('show');
            
            // Clear previous timeout if exists
            if (alertTimeout) {
                clearTimeout(alertTimeout);
            }
            
            // Hide after 3 seconds
            alertTimeout = setTimeout(() => {
                alertFeedback.classList.remove('show');
            }, 3000);
        }
        
        // Show directional arrow
        function showDirectionArrow(direction) {
            // Hide all arrows first
            hideAllArrows();
            
            // Skip if arrows are disabled
            if (!config.showDirectionArrows) return;
            
            // Skip for perfect and no_book states
            if (direction === 'perfect' || direction === 'no_book') return;
            
            // For closer/further, show movement indicator instead
            if (direction === 'closer' || direction === 'further') {
                movementIcon.className = 'fas ' + directionIcons[direction];
                movementIndicator.classList.add('indicator-visible');
                
                // Hide after timeout
                setTimeout(() => {
                    movementIndicator.classList.remove('indicator-visible');
                }, config.directionArrowDuration);
                
                return;
            }
            
            // Apply direction reversal if enabled
            if (config.reverseDirections) {
                if (direction === 'left') direction = 'right';
                else if (direction === 'right') direction = 'left';
                else if (direction === 'up') direction = 'down';
                else if (direction === 'down') direction = 'up';
            }
            
            // Show the appropriate arrow
            let arrow;
            switch (direction) {
                case 'up': arrow = arrowUp; break;
                case 'down': arrow = arrowDown; break;
                case 'left': arrow = arrowLeft; break;
                case 'right': arrow = arrowRight; break;
                default: return;
            }
            
            arrow.classList.add('arrow-visible');
            
            // Clear previous timeout
            if (arrowTimeout) {
                clearTimeout(arrowTimeout);
            }
            
            // Hide after duration
            arrowTimeout = setTimeout(() => {
                hideAllArrows();
            }, config.directionArrowDuration);
        }
        
        // Hide all direction arrows
        function hideAllArrows() {
            arrowUp.classList.remove('arrow-visible');
            arrowDown.classList.remove('arrow-visible');
            arrowLeft.classList.remove('arrow-visible');
            arrowRight.classList.remove('arrow-visible');
            movementIndicator.classList.remove('indicator-visible');
        }
        
        // Main detection loop
        async function detectObjects() {
            try {
                // Wait for video to be ready
                if (video.readyState < 2) {
                    requestAnimationFrame(detectObjects);
                    return;
                }
                
                // Get video frame
                const predictions = await model.detect(video);
                
                // Process the results
                processDetections(predictions);
                
                // Continue detection
                requestAnimationFrame(detectObjects);
            } catch (error) {
                console.error('Detection error:', error);
                
                // Try to recover and continue
                setTimeout(() => {
                    requestAnimationFrame(detectObjects);
                }, 1000);
            }
        }
        
        // Process detection results
        function processDetections(predictions) {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw target area (yellow rectangle)
            ctx.strokeStyle = '#f39c12';
            ctx.lineWidth = 2;
            ctx.strokeRect(
                targetArea.x,
                targetArea.y,
                targetArea.width,
                targetArea.height
            );
            
            // Draw center marker if enabled
            if (config.showCenterMarker) {
                ctx.strokeStyle = '#2ecc71';
                ctx.lineWidth = 2;
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                ctx.beginPath();
                ctx.moveTo(centerX - 10, centerY);
                ctx.lineTo(centerX + 10, centerY);
                ctx.moveTo(centerX, centerY - 10);
                ctx.lineTo(centerX, centerY + 10);
                ctx.stroke();
            }
            
            // Process detection results
            const currentTime = Date.now();
            
            // Find book in predictions
            let bookDetected = false;
            let bookData = null;
            let highestConfidence = 0;
            
            for (const prediction of predictions) {
                if (prediction.class === 'book' && prediction.score > config.detectionConfidence) {
                    // Track highest confidence detection
                    if (prediction.score > highestConfidence) {
                        highestConfidence = prediction.score;
                        bookDetected = true;
                        lastBookDetectionTime = currentTime;
                        detectionCount++;
                        
                        // Extract book coordinates
                        const [x, y, width, height] = prediction.bbox;
                        
                        // Draw book bounding box if enabled
                        if (config.highlightDetections) {
                            ctx.strokeStyle = '#e74c3c';
                            ctx.lineWidth = 3;
                            ctx.strokeRect(x, y, width, height);
                            
                            // Add confidence label
                            ctx.fillStyle = 'rgba(231, 76, 60, 0.7)';
                            ctx.fillRect(x, y - 20, 70, 20);
                            ctx.fillStyle = 'white';
                            ctx.font = '12px Arial';
                            ctx.fillText(`${Math.round(prediction.score * 100)}% Book`, x + 5, y - 5);
                        }
                        
                        // Analyze book position
                        bookData = analyzeBookPosition(x, y, width, height);
                        lastConfidence = prediction.score;
                        
                        // Update statistics
                        statDetections.textContent = detectionCount;
                        statConfidence.textContent = `${Math.round(prediction.score * 100)}%`;
                    }
                }
            }
            
            // State management
            if (bookDetected && bookData) {
                let newState = null;
                
                // Size check first
                if (bookData.sizeRatio < config.minSizeRatio) {
                    newState = 'closer';
                } else if (bookData.sizeRatio > config.maxSizeRatio) {
                    newState = 'further';
                } 
                // Only check position if size is good
                else {
                    // Position check - using separate X and Y thresholds
                    const thresholdX = canvas.width * config.positionThresholdXRatio;
                    const thresholdY = canvas.height * config.positionThresholdYRatio;
                    
                    if (Math.abs(bookData.offsetX) > thresholdX) {
                        newState = bookData.offsetX > 0 ? 'right' : 'left';
                    } else if (Math.abs(bookData.offsetY) > thresholdY) {
                        newState = bookData.offsetY > 0 ? 'down' : 'up';
                    } else {
                        newState = 'perfect';
                    }
                }
                
                // State transition
                if (newState !== currentState && (currentTime - lastInstructionTime) > config.instructionCooldown) {
                    updateStatus(newState, bookData);
                    showDirectionArrow(newState);
                    currentState = newState;
                    lastInstructionTime = currentTime;
                    
                    // Auto-capture OCR when alignment is perfect
                    if (newState === 'perfect' && ocrInitialized && !ocrProcessing && 
                        ocrAutoCapture && ocrAutoCapture.checked &&
                        (currentTime - lastOCRCaptureTime > 5000)) {
                        
                        setTimeout(() => {
                            captureText();
                            lastOCRCaptureTime = currentTime;
                        }, 500);
                    }
                    
                    // Set up repeat instructions if enabled
                    if (config.repeatInstructions && newState !== 'perfect') {
                        if (repeatTimeout) {
                            clearTimeout(repeatTimeout);
                        }
                        
                        repeatTimeout = setInterval(() => {
                            if (currentState === newState) {
                                // Repeat the instruction
                                if (audioEnabled) {
                                    const displayState = config.reverseDirections && 
                                        ['left', 'right', 'up', 'down'].includes(newState) ? 
                                        getReversedDirection(newState) : newState;
                                    
                                    speak(messages[displayState].th, 'th');
                                }
                            } else {
                                // Stop repeating if state changed
                                clearInterval(repeatTimeout);
                            }
                        }, 5000); // Repeat every 5 seconds
                    }
                }
            } else if (currentTime - lastBookDetectionTime > 3000) {
                // No book detected for 3 seconds
                if ((currentTime - lastInstructionTime) > config.instructionCooldown) {
                    updateStatus('no_book', null);
                    hideAllArrows();
                    currentState = 'no_book';
                    lastInstructionTime = currentTime;
                    
                    // Clear repeat timeout
                    if (repeatTimeout) {
                        clearInterval(repeatTimeout);
                    }
                }
            }
        }
        
        // Get reversed direction
        function getReversedDirection(direction) {
            switch (direction) {
                case 'left': return 'right';
                case 'right': return 'left';
                case 'up': return 'down';
                case 'down': return 'up';
                default: return direction;
            }
        }
        
        // Analyze book position
        function analyzeBookPosition(x, y, width, height) {
            // Book center
            const centerX = x + width / 2;
            const centerY = y + height / 2;
            
            // Offset from screen center
            const offsetX = centerX - (canvas.width / 2);
            const offsetY = centerY - (canvas.height / 2);
            
            // Size ratio compared to target area
            const bookArea = width * height;
            const targetAreaSize = targetArea.width * targetArea.height;
            const sizeRatio = bookArea / targetAreaSize;
            
            return {
                offsetX,
                offsetY,
                sizeRatio,
                width,
                height,
                centerX,
                centerY
            };
        }
        
        // Update status display and speak instructions
        function updateStatus(state, bookData) {
            // Get proper direction based on reversal setting
            let displayState = state;
            
            // Only reverse direction states
            if (config.reverseDirections && ['left', 'right', 'up', 'down'].includes(state)) {
                displayState = getReversedDirection(state);
            }
            
            // Get associated icon
            const icon = directionIcons[state] ? 
                `<i class="fas ${directionIcons[state]} me-2"></i>` : 
                '<i class="fas fa-info-circle me-2"></i>';
            
            // Speak instruction
            if (audioEnabled) {
                // Speak the actual command needed, considering reversal
                speak(messages[displayState].th, 'th');
            }
            
            // Update overlay text with icon - show the actual displayed command to match speech
            statusOverlay.innerHTML = `${icon}<span class="thai-text">${messages[displayState].th}</span>, ${messages[displayState].en}`;
            
            // Apply animation
            statusOverlay.classList.remove('flash');
            void statusOverlay.offsetWidth; // Trigger reflow
            statusOverlay.classList.add('flash');
            
            // Special effects for perfect alignment
            if (state === 'perfect') {
                statusOverlay.classList.add('pulse');
            } else {
                statusOverlay.classList.remove('pulse');
            }
            
            // Update overlay color
            statusOverlay.className = 'status-overlay';
            if (statusColors[state]) {
                statusOverlay.classList.add(statusColors[state]);
            }
            
            // Update detection details
            if (bookData) {
                // Progress bar value based on positioning
                let progressValue = 0;
                
                // Calculate progress (0-100) based on how close we are to perfect alignment
                if (state === 'perfect') {
                    progressValue = 100;
                } else if (state === 'closer') {
                    progressValue = (bookData.sizeRatio / config.minSizeRatio) * 100;
                } else if (state === 'further') {
                    progressValue = (config.maxSizeRatio / bookData.sizeRatio) * 100;
                } else if (['left', 'right'].includes(state)) {
                    // Horizontal alignment percentage
                    const horizontalMax = canvas.width * config.positionThresholdXRatio;
                    progressValue = 100 - (Math.abs(bookData.offsetX) / horizontalMax * 100);
                } else if (['up', 'down'].includes(state)) {
                    // Vertical alignment percentage
                    const verticalMax = canvas.height * config.positionThresholdYRatio;
                    progressValue = 100 - (Math.abs(bookData.offsetY) / verticalMax * 100);
                }
                
                // Constrain to 0-100 range
                progressValue = Math.max(0, Math.min(100, progressValue));
                
                // Display progress bar and stats
                statusDetails.innerHTML = `
                    <div class="mb-3">
                        <span class="badge ${state === 'perfect' ? 'bg-success' : 'bg-warning'} fs-6 mb-2">
                            <i class="fas ${directionIcons[displayState]} me-1"></i>
                            <span class="thai-text">${messages[displayState].th}</span>, ${messages[displayState].en}
                        </span>
                        <div class="progress mb-2" style="height: 10px;">
                            <div class="progress-bar ${state === 'perfect' ? 'bg-success' : 'bg-warning'}" 
                                 role="progressbar" 
                                 style="width: ${progressValue}%"
                                 aria-valuenow="${progressValue}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Size Ratio:</strong></td>
                            <td class="text-end">${bookData.sizeRatio.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td><strong>Position X:</strong></td>
                            <td class="text-end">
                                ${Math.round(bookData.offsetX)}px 
                                ${bookData.offsetX > 0 ? '<i class="fas fa-arrow-right text-warning"></i>' : 
                                  bookData.offsetX < 0 ? '<i class="fas fa-arrow-left text-warning"></i>' : 
                                  '<i class="fas fa-check text-success"></i>'}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Position Y:</strong></td>
                            <td class="text-end">
                                ${Math.round(bookData.offsetY)}px 
                                ${bookData.offsetY > 0 ? '<i class="fas fa-arrow-down text-warning"></i>' : 
                                  bookData.offsetY < 0 ? '<i class="fas fa-arrow-up text-warning"></i>' : 
                                  '<i class="fas fa-check text-success"></i>'}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Dimensions:</strong></td>
                            <td class="text-end">${Math.round(bookData.width)}×${Math.round(bookData.height)}px</td>
                        </tr>
                    </table>
                `;
            } else {
                statusDetails.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-book fa-3x mb-3 text-secondary"></i>
                        <p><strong>No book detected</strong></p>
                        <p class="text-muted">Hold a book in front of the camera</p>
                    </div>
                `;
            }
        }
        
        // Speak text using SpeechSynthesis
        function speak(text, lang = 'th') {
            // Check browser support
            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                window.speechSynthesis.cancel();
                
                // Create utterance
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Try to find a Thai voice
                const voices = window.speechSynthesis.getVoices();
                const voiceForLang = voices.find(voice => voice.lang.includes(lang));
                
                if (voiceForLang) {
                    utterance.voice = voiceForLang;
                }
                
                // Set rate and pitch from accessibility settings
                utterance.rate = config.speechRate;
                utterance.volume = config.speechVolume;
                
                // Speak
                window.speechSynthesis.speak(utterance);
            }
        }
        
        // Capture text from current video frame
        async function captureText() {
            if (!tesseractLoaded || typeof Tesseract === 'undefined') {
                showAlert('OCR not loaded yet. Please wait or refresh the page.', 'warning');
                return;
            }
            
            if (!ocrInitialized) {
                showAlert('OCR initializing. Please wait a moment...', 'info');
                await initializeOCR();
            }
            
            if (ocrProcessing) {
                showAlert('OCR is already processing an image', 'info');
                return;
            }
            
            try {
                ocrProcessing = true;
                updateOCRStatus('processing', 'Processing image...');
                showOCRProgress(10);
                
                // Show visual feedback
                showOCRCaptureArea();
                showOCRCaptureFlash();
                
                // Create a canvas with the current video frame
                const captureCanvas = document.createElement('canvas');
                const ctx = captureCanvas.getContext('2d');
                
                // Get the area inside the target rectangle for better OCR results
                captureCanvas.width = targetArea.width;
                captureCanvas.height = targetArea.height;
                
                // Draw only the region inside the target rectangle
                ctx.drawImage(
                    video, 
                    targetArea.x, targetArea.y, targetArea.width, targetArea.height, 
                    0, 0, captureCanvas.width, captureCanvas.height
                );
                
                showOCRProgress(30);
                
                // Get image data URL
                const imageData = captureCanvas.toDataURL('image/png');
                
                showOCRProgress(40);
                
                // Configure OCR options based on language
                const ocrOptions = {
                    lang: ocrLanguage
                };
                
                // For Thai, use settings optimized for Thai script
                if (ocrLanguage === 'tha') {
                    ocrOptions.tessedit_char_whitelist = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789กขฃคฅฆงจฉชซฌญฎฏฐฑฒณดตถทธนบปผฝพฟภมยรลวศษสหฬอฮฤฦะัาำิีึืุูเแโใไ็่้๊๋์ๆฯ.,;:\'"!@#$%^&*(){}[]<>|_+-= ';
                    ocrOptions.preserve_interword_spaces = '1';
                }
                
                showOCRProgress(60);
                
                // Recognize text
                const result = await ocrWorker.recognize(imageData, ocrOptions);
                
                showOCRProgress(90);
                
                // Process the result
                const extractedText = result.data.text.trim();
                
                // Display result
                if (extractedText) {
                    // Set text with proper language
                    ocrText.className = ocrLanguage === 'tha' ? 'thai-text' : '';
                    ocrText.innerHTML = extractedText.replace(/\n/g, '<br>');
                    
                    // Show preview
                    ocrPreview.style.display = 'block';
                    
                    // Enable buttons
                    ocrCopyBtn.disabled = false;
                    ocrSpeakBtn.disabled = false;
                    
                    // Store result
                    ocrLastResult = extractedText;
                    
                    // Update status
                    updateOCRStatus('success', 'Text extracted successfully!');
                    
                    // Vibration feedback on mobile
                    if ('vibrate' in navigator) {
                        navigator.vibrate(200);
                    }
                } else {
                    // No text found
                    updateOCRStatus('warning', 'No text found in the image');
                    ocrPreview.style.display = 'block';
                    ocrText.innerHTML = '<em class="text-muted">No text detected. Try adjusting the book position or lighting.</em>';
                    
                    // Disable buttons
                    ocrCopyBtn.disabled = true;
                    ocrSpeakBtn.disabled = true;
                    
                    // Clear result
                    ocrLastResult = '';
                }
                
                showOCRProgress(100);
                
            } catch (error) {
                console.error('OCR error:', error);
                updateOCRStatus('error', 'OCR error: ' + error.message);
                
                // Hide preview if error
                ocrPreview.style.display = 'none';
                
                // Disable buttons
                ocrCopyBtn.disabled = true;
                ocrSpeakBtn.disabled = true;
            } finally {
                ocrProcessing = false;
                
                // Hide progress bar after delay
                setTimeout(() => {
                    ocrProgress.style.display = 'none';
                }, 1000);
            }
        }
        
        // Update OCR status display
        function updateOCRStatus(type, message) {
            if (!ocrStatus) return;
            
            ocrStatus.className = 'alert';
            switch(type) {
                case 'loading':
                case 'initializing':
                case 'processing':
                    ocrStatus.classList.add('alert-info');
                    ocrStatus.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i> ${message}`;
                    break;
                case 'ready':
                    ocrStatus.classList.add('alert-info');
                    ocrStatus.innerHTML = `<i class="fas fa-info-circle me-2"></i> ${message}`;
                    break;
                case 'success':
                    ocrStatus.classList.add('alert-success');
                    ocrStatus.innerHTML = `<i class="fas fa-check-circle me-2"></i> ${message}`;
                    break;
                case 'warning':
                    ocrStatus.classList.add('alert-warning');
                    ocrStatus.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i> ${message}`;
                    break;
                case 'error':
                    ocrStatus.classList.add('alert-danger');
                    ocrStatus.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i> ${message}`;
                    break;
            }
        }
        
        // Show OCR progress bar
        function showOCRProgress(percentage) {
            if (!ocrProgress || !ocrProgressBar) return;
            
            ocrProgress.style.display = 'flex';
            ocrProgressBar.style.width = `${percentage}%`;
            ocrProgressBar.setAttribute('aria-valuenow', percentage);
        }
        
        // Show OCR capture area
        function showOCRCaptureArea() {
            if (!ocrCaptureArea) return;
            
            ocrCaptureArea.style.left = targetArea.x + 'px';
            ocrCaptureArea.style.top = targetArea.y + 'px';
            ocrCaptureArea.style.width = targetArea.width + 'px';
            ocrCaptureArea.style.height = targetArea.height + 'px';
            ocrCaptureArea.style.display = 'block';
            
            setTimeout(() => {
                ocrCaptureArea.style.display = 'none';
            }, 2000);
        }
        
        // Show OCR capture flash effect
        function showOCRCaptureFlash() {
            if (!ocrCaptureFlash) return;
            
            ocrCaptureFlash.classList.add('ocr-flash-active');
            
            setTimeout(() => {
                ocrCaptureFlash.classList.remove('ocr-flash-active');
            }, 500);
        }
        
        // Copy OCR result to clipboard
        function copyOCRResult() {
            if (!ocrLastResult) return;
            
            navigator.clipboard.writeText(ocrLastResult)
                .then(() => {
                    showAlert('Text copied to clipboard', 'success');
                })
                .catch(err => {
                    console.error('Could not copy text: ', err);
                    showAlert('Error copying text', 'danger');
                });
        }
        
        // Speak OCR result using text-to-speech
        function speakOCRResult() {
            if (!ocrLastResult) return;
            
            // Use the language from OCR detection
            const langCode = ocrLanguage === 'tha' ? 'th' : 'en';
            speak(ocrLastResult, langCode);
        }
        
        // Take a snapshot of current video frame
        function takeSnapshot() {
            try {
                // Draw current frame to a temporary canvas
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = video.videoWidth;
                tempCanvas.height = video.videoHeight;
                const tempCtx = tempCanvas.getContext('2d');
                
                // Draw video
                tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
                
                // Draw overlay (target area, detections, etc.)
                tempCtx.drawImage(canvas, 0, 0);
                
                // Convert to data URL
                const dataURL = tempCanvas.toDataURL('image/jpeg');
                
                // Create a new window with the image
                const newWindow = window.open();
                newWindow.document.write(`<img src="${dataURL}" style="max-width: 100%;">`);
                
                // Show feedback
                showAlert('Snapshot taken successfully', 'success');
            } catch (error) {
                console.error('Error taking snapshot:', error);
                showAlert('Error taking snapshot', 'danger');
            }
        }
        
        // Toggle fullscreen
        function toggleFullscreen() {
            const container = document.querySelector('.video-container');
            
            if (!document.fullscreenElement) {
                container.requestFullscreen()
                    .then(() => {
                        container.classList.add('fullscreen');
                        fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i> Exit';
                    })
                    .catch(err => {
                        console.error(`Fullscreen error: ${err.message}`);
                        showAlert('Fullscreen error: ' + err.message, 'danger');
                    });
            } else {
                document.exitFullscreen()
                    .then(() => {
                        container.classList.remove('fullscreen');
                        fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i> Fullscreen';
                    })
                    .catch(err => {
                        console.error(`Exit fullscreen error: ${err.message}`);
                    });
            }
        }
        
        // Reset settings to defaults
        function resetToDefaults() {
            // Default values
            config.targetWidthRatio = 0.7;
            config.targetHeightRatio = 0.8;
            config.detectionConfidence = 0.5;
            config.positionThresholdXRatio = 0.05;
            config.positionThresholdYRatio = 0.07;
            config.minSizeRatio = 0.5;
            config.maxSizeRatio = 1.2;
            config.highlightDetections = true;
            config.showCenterMarker = true;
            config.showDirectionArrows = true;
            
            // Keep reverseDirections based on device detection
            if (isComputer) {
                config.reverseDirections = true;
            } else {
                config.reverseDirections = false;
            }
            
            // Reset accessibility settings
            config.highContrastMode = false;
            config.largerElements = false;
            config.speechRate = 1.0;
            config.speechVolume = 1.0;
            config.repeatInstructions = false;
            config.extraAudioCues = false;
            
            // Update UI controls
            initializeSettings();
            
            // Update target area and guide
            updateTargetArea();
            updateGuideOverlay();
            
            // Apply accessibility settings
            applyAccessibilitySettings();
            
            // Show feedback
            showAlert('Settings reset to defaults', 'success');
        }
        
        // Update configuration from settings panel
        function updateConfig() {
            config.detectionConfidence = parseFloat(confidenceThreshold.value);
            config.positionThresholdXRatio = parseFloat(positionToleranceX.value);
            config.positionThresholdYRatio = parseFloat(positionToleranceY.value);
            config.minSizeRatio = parseFloat(minSizeRatio.value);
            config.maxSizeRatio = parseFloat(maxSizeRatio.value);
            config.reverseDirections = reverseDirections.checked;
            config.highlightDetections = detectionHighlight.checked;
            config.showCenterMarker = showCenterMarker.checked;
            config.showDirectionArrows = showDirectionArrows.checked;
            
            // Update target area
            updateTargetArea();
            
            // Update guide overlay
            updateGuideOverlay();
        }
        
        // Update accessibility configuration
        function updateAccessibilityConfig() {
            config.highContrastMode = highContrastMode.checked;
            config.largerElements = largerElements.checked;
            config.speechRate = parseFloat(speechRate.value);
            config.speechVolume = parseFloat(speechVolume.value);
            config.repeatInstructions = repeatInstructions.checked;
            config.extraAudioCues = extraAudioCues.checked;
            
            // Apply settings
            applyAccessibilitySettings();
        }
        
        // Ensure voices are loaded (for Safari)
        function loadVoices() {
            // Get voices for text-to-speech
            window.speechSynthesis.getVoices();
            
            // For browsers that need onvoiceschanged
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = function() {
                    window.speechSynthesis.getVoices();
                };
            }
        }
        
        // EVENT LISTENERS
        
        // OCR Button (main capture button)
        if (ocrCaptureBtn) {
            ocrCaptureBtn.addEventListener('click', () => {
                if (!tesseractLoaded) {
                    showAlert('OCR library is still loading. Please wait...', 'info');
                    return;
                }
                
                if (!ocrInitialized) {
                    showAlert('Initializing OCR. Please wait...', 'info');
                    initializeOCR().then(() => {
                        captureText();
                    });
                } else {
                    captureText();
                }
            });
        }
        
        // OCR Language selection
        if (ocrLangTha) {
            ocrLangTha.addEventListener('change', () => {
                if (ocrLangTha.checked) {
                    ocrLanguage = 'tha';
                    if (ocrInitialized && ocrWorker) {
                        ocrWorker.loadLanguage('tha').then(() => {
                            ocrWorker.initialize('tha');
                        }).catch(err => {
                            console.error('Error changing to Thai:', err);
                        });
                    }
                }
            });
        }
        
        if (ocrLangEng) {
            ocrLangEng.addEventListener('change', () => {
                if (ocrLangEng.checked) {
                    ocrLanguage = 'eng';
                    if (ocrInitialized && ocrWorker) {
                        ocrWorker.loadLanguage('eng').then(() => {
                            ocrWorker.initialize('eng');
                        }).catch(err => {
                            console.error('Error changing to English:', err);
                        });
                    }
                }
            });
        }
        
        // OCR Copy and Speak buttons
        if (ocrCopyBtn) {
            ocrCopyBtn.addEventListener('click', copyOCRResult);
        }
        
        if (ocrSpeakBtn) {
            ocrSpeakBtn.addEventListener('click', speakOCRResult);
        }
        
        // Camera Toggle
        if (cameraToggle) {
            cameraToggle.addEventListener('click', async () => {
                // Show loading indicator
                statusOverlay.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Switching camera...';
                
                // Toggle facing mode
                facingMode = facingMode === 'user' ? 'environment' : 'user';
                
                // Restart camera (with small delay to show loading status)
                setTimeout(async () => {
                    try {
                        await setupCamera();
                        showAlert('Camera switched successfully', 'success');
                    } catch (error) {
                        console.error('Error toggling camera:', error);
                        showAlert('Error switching camera', 'danger');
                    }
                }, 500);
            });
        }
        
        // Audio Toggle
        if (audioToggle) {
            audioToggle.addEventListener('click', () => {
                audioEnabled = !audioEnabled;
                audioToggle.innerHTML = audioEnabled ? 
                    '<i class="fas fa-volume-high"></i> Audio' : 
                    '<i class="fas fa-volume-xmark"></i> Muted';
                
                // Update button color
                if (audioEnabled) {
                    audioToggle.classList.remove('btn-outline-secondary');
                    audioToggle.classList.add('btn-secondary');
                } else {
                    audioToggle.classList.remove('btn-secondary');
                    audioToggle.classList.add('btn-outline-secondary');
                }
                
                showAlert(audioEnabled ? 'Audio enabled' : 'Audio disabled', 'info');
            });
        }
        
        // Snapshot Button
        if (snapshotBtn) {
            snapshotBtn.addEventListener('click', takeSnapshot);
        }
        
        // Fullscreen Toggle
        if (fullscreenBtn) {
            fullscreenBtn.addEventListener('click', toggleFullscreen);
        }
        
        // Guide Toggle
        if (guideToggle) {
            guideToggle.addEventListener('click', () => {
                guideVisible = !guideVisible;
                guideOverlay.style.display = guideVisible ? 'block' : 'none';
                
                // Update button text
                guideToggle.innerHTML = guideVisible ? 
                    '<i class="fas fa-eye-slash"></i> Hide' : 
                    '<i class="fas fa-ruler-combined"></i> Guide';
            });
        }
        
        // Settings Panel Toggle
        if (settingsToggle) {
            settingsToggle.addEventListener('click', () => {
                settingsPanel.classList.toggle('active');
            });
        }
        
        // Settings Panel Close
        if (settingsClose) {
            settingsClose.addEventListener('click', () => {
                settingsPanel.classList.remove('active');
            });
        }
        
        // Accessibility Panel Toggle
        if (accessibilityToggle) {
            accessibilityToggle.addEventListener('click', () => {
                accessibilityPanel.classList.toggle('active');
            });
        }
        
        // Accessibility Panel Close
        if (accessibilityClose) {
            accessibilityClose.addEventListener('click', () => {
                accessibilityPanel.classList.remove('active');
            });
        }
        
        // Settings sliders and checkboxes
        if (confidenceThreshold) {
            confidenceThreshold.addEventListener('input', () => {
                confidenceValue.textContent = confidenceThreshold.value;
                config.detectionConfidence = parseFloat(confidenceThreshold.value);
            });
        }
        
        if (positionToleranceX) {
            positionToleranceX.addEventListener('input', () => {
                toleranceXValue.textContent = positionToleranceX.value;
                config.positionThresholdXRatio = parseFloat(positionToleranceX.value);
            });
        }
        
        if (positionToleranceY) {
            positionToleranceY.addEventListener('input', () => {
                toleranceYValue.textContent = positionToleranceY.value;
                config.positionThresholdYRatio = parseFloat(positionToleranceY.value);
            });
        }
        
        if (minSizeRatio) {
            minSizeRatio.addEventListener('input', () => {
                minSizeValue.textContent = minSizeRatio.value;
                config.minSizeRatio = parseFloat(minSizeRatio.value);
            });
        }
        
        if (maxSizeRatio) {
            maxSizeRatio.addEventListener('input', () => {
                maxSizeValue.textContent = maxSizeRatio.value;
                config.maxSizeRatio = parseFloat(maxSizeRatio.value);
            });
        }
        
        // Other setting controls
        if (reverseDirections) {
            reverseDirections.addEventListener('change', () => {
                config.reverseDirections = reverseDirections.checked;
            });
        }
        
        if (detectionHighlight) {
            detectionHighlight.addEventListener('change', () => {
                config.highlightDetections = detectionHighlight.checked;
            });
        }
        
        if (showCenterMarker) {
            showCenterMarker.addEventListener('change', () => {
                config.showCenterMarker = showCenterMarker.checked;
            });
        }
        
        if (showDirectionArrows) {
            showDirectionArrows.addEventListener('change', () => {
                config.showDirectionArrows = showDirectionArrows.checked;
            });
        }
        
        // Reset settings button
        if (resetSettings) {
            resetSettings.addEventListener('click', resetToDefaults);
        }
        
        // Accessibility settings controls
        if (highContrastMode) {
            highContrastMode.addEventListener('change', () => {
                config.highContrastMode = highContrastMode.checked;
                applyAccessibilitySettings();
            });
        }
        
        if (largerElements) {
            largerElements.addEventListener('change', () => {
                config.largerElements = largerElements.checked;
                applyAccessibilitySettings();
            });
        }
        
        if (speechRate) {
            speechRate.addEventListener('input', () => {
                speechRateValue.textContent = speechRate.value;
                config.speechRate = parseFloat(speechRate.value);
            });
        }
        
        if (speechVolume) {
            speechVolume.addEventListener('input', () => {
                speechVolumeValue.textContent = speechVolume.value;
                config.speechVolume = parseFloat(speechVolume.value);
            });
        }
        
        if (repeatInstructions) {
            repeatInstructions.addEventListener('change', () => {
                config.repeatInstructions = repeatInstructions.checked;
                config.instructionCooldown = config.repeatInstructions ? 2000 : 3000;
            });
        }
        
        if (extraAudioCues) {
            extraAudioCues.addEventListener('change', () => {
                config.extraAudioCues = extraAudioCues.checked;
            });
        }
        
        // Handle document fullscreen change
        document.addEventListener('fullscreenchange', () => {
            const container = document.querySelector('.video-container');
            if (!document.fullscreenElement) {
                container.classList.remove('fullscreen');
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i> Fullscreen';
            }
        });
        
        // Load voices for speech synthesis
        if ('speechSynthesis' in window) {
            loadVoices();
        }
        
        // Initialize the app when document is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
